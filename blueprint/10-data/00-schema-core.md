# Database Schema (Core)

**Last Updated:** 2025-11-22
**Status:** ✅ IMPLEMENTED

**CRITICAL:** This is the **single source of truth** for the database schema. All schema changes must be documented here first, then implemented.

## Schema Overview

Payload Exchange uses **3 core tables** to manage sponsors, actions, and redemptions.

```
sponsors ──< actions ──< redemptions
```

**Simplified Design:**
- No separate `sponsor_balances` table (balance on `sponsors`)
- No `resources` table (resources in `public/resources.json`)
- No `x402_payments` table (payments processed in real-time)

---

## Table Definitions

### `sponsors`

Entities that fund actions and pay for user API access.

```typescript
sponsors {
  id: text (primary key, UUID)
  wallet_address: varchar(255) (unique, not null)
  balance: bigint (not null)
  created_at: timestamp (not null, default now())
  updated_at: timestamp (not null, default now())
}
```

**Indexes:**
- `wallet_address` (unique)

**Business Rules:**
- One sponsor per wallet address
- Balance in smallest currency unit (e.g., USDC has 6 decimals: 1000000 = 1 USDC)
- Balance cannot go negative (enforced in `updateSponsorBalance` query)

**Example:**
```typescript
{
  id: "550e8400-e29b-41d4-a716-446655440000",
  wallet_address: "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb1",
  balance: 1000000000n,  // 1000 USDC (6 decimals)
  created_at: "2025-11-22T10:00:00Z",
  updated_at: "2025-11-22T10:00:00Z"
}
```

---

### `actions`

Sponsor-configured actions that users can complete to unlock API access.

```typescript
actions {
  id: text (primary key, UUID)
  sponsor_id: text (foreign key → sponsors.id, cascade delete)
  plugin_id: varchar(100) (not null, e.g., "act_email_capture")
  config: jsonb (not null, plugin-specific configuration)
  coverage_type: enum("full" | "percent") (not null)
  coverage_percent: bigint (nullable, 0-100 when coverage_type="percent")
  recurrence: enum("one_time_per_user" | "per_request") (not null)
  resource_id: varchar(500) (not null, e.g., "weather.com/forecast")
  created_at: timestamp (not null, default now())
}
```

**Enums:**
```typescript
coverage_type: "full" | "percent"
recurrence: "one_time_per_user" | "per_request"
```

**Indexes:**
- `sponsor_id`
- `resource_id`
- `plugin_id`

**Business Rules:**
- `coverage_type`:
  - `"full"`: Sponsor pays 100% of x402 charge
  - `"percent"`: Sponsor pays partial (coverage_percent%), user pays rest
- `coverage_percent`: Required when `coverage_type="percent"`, must be 0-100
- `recurrence`:
  - `"one_time_per_user"`: User can redeem only once ever
  - `"per_request"`: User can redeem unlimited times
- `resource_id`: String identifier matching `public/resources.json`

**Example (Full Coverage):**
```typescript
{
  id: "action-123",
  sponsor_id: "sponsor-456",
  plugin_id: "act_email_capture",
  config: {
    prompt: "Enter your email to unlock",
    requireName: false
  },
  coverage_type: "full",
  coverage_percent: null,
  recurrence: "one_time_per_user",
  resource_id: "weather.com/forecast",
  created_at: "2025-11-22T10:00:00Z"
}
```

**Example (Partial Coverage):**
```typescript
{
  id: "action-789",
  sponsor_id: "sponsor-456",
  plugin_id: "act_github_star",
  config: {
    repo: "microchipgnu/payload-exchange",
    requireUsername: true
  },
  coverage_type: "percent",
  coverage_percent: 50n,  // Sponsor pays 50%, user pays 50%
  recurrence: "per_request",
  resource_id: "api.github.com/repos",
  created_at: "2025-11-22T10:00:00Z"
}
```

---

### `redemptions`

User action instances (pending/completed/failed).

```typescript
redemptions {
  id: text (primary key, UUID)
  action_id: text (foreign key → actions.id, cascade delete)
  user_id: varchar(255) (not null, wallet address or session ID)
  resource_id: varchar(500) (not null)
  instance_id: varchar(255) (not null, unique per action instance)
  status: enum("pending" | "completed" | "failed") (default "pending")
  created_at: timestamp (not null, default now())
  completed_at: timestamp (nullable, set when status="completed")
}
```

**Enum:**
```typescript
status: "pending" | "completed" | "failed"
```

**Indexes:**
- `action_id, user_id`
- `status`
- `instance_id` (unique)

**Business Rules:**
- Status flow: `pending` → `completed` or `failed`
- `completed_at` set automatically when status becomes "completed"
- `instance_id` generated by plugin's `start()` method

**Example:**
```typescript
{
  id: "redemption-abc",
  action_id: "action-123",
  user_id: "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb1",
  resource_id: "weather.com/forecast",
  instance_id: "550e8400-e29b-41d4-a716-446655440001",
  status: "completed",
  created_at: "2025-11-22T10:00:00Z",
  completed_at: "2025-11-22T10:05:00Z"
}
```

---

## Relationships

```
sponsors (1) ──< (N) actions
actions (1) ──< (N) redemptions
```

**Drizzle Relations:**
```typescript
export const sponsorsRelations = relations(sponsors, ({ many }) => ({
  actions: many(actions),
}));

export const actionsRelations = relations(actions, ({ one, many }) => ({
  sponsor: one(sponsors, {
    fields: [actions.sponsorId],
    references: [sponsors.id],
  }),
  redemptions: many(redemptions),
}));

export const redemptionsRelations = relations(redemptions, ({ one }) => ({
  action: one(actions, {
    fields: [redemptions.actionId],
    references: [actions.id],
  }),
}));
```

---

## Data Types

| Type | Storage | Notes |
|------|---------|-------|
| `text` | TEXT | For UUIDs, IDs |
| `varchar(N)` | VARCHAR(N) | For addresses, resource IDs |
| `bigint` | BIGINT | For currency amounts (smallest unit), percentages |
| `jsonb` | JSONB | For plugin configs (Postgres JSONB for performance) |
| `timestamp` | TIMESTAMP WITH TIME ZONE | Always UTC |
| `enum` | ENUM (Postgres) | Type-safe enums |

---

## Migration Strategy

- All migrations in `drizzle/` directory
- Use Drizzle Kit for schema generation: `pnpm db:generate`
- Push to Neon: `pnpm db:push` or `pnpm db:migrate`
- Neon automatically handles connection pooling

**Current Migration:**
```bash
drizzle/
├── meta/
│   ├── _journal.json
│   └── 0000_snapshot.json
└── 0000_initial.sql
```

---

## Resources (External)

**Location:** `public/resources.json`

Resources are **not stored in the database**. Instead, they're managed in a JSON file:

```json
{
  "id": "weather.com/forecast",
  "name": "Weather API",
  "description": "Get weather forecasts",
  "baseUrl": "https://weather.com",
  "avgPrice": "1000000",
  "currency": "USDC:base"
}
```

**Why JSON instead of DB?**
- Faster to iterate during hackathon
- Resources are mostly static
- Can be migrated to DB later if needed

---

## Seed Data (Development)

**Required seed data:**
1. **Sponsor:** One test sponsor with balance
2. **Actions:** One of each plugin type
3. **Resources:** Already in `public/resources.json`

**Location:** `server/db/seed.ts` (create if needed)

**Example seed:**
```typescript
// Seed sponsor
await createSponsor("0xTEST_WALLET_ADDRESS");

// Seed action
await createAction({
  sponsorId: "sponsor-id",
  pluginId: "act_email_capture",
  config: { prompt: "Enter email" },
  coverageType: "full",
  recurrence: "one_time_per_user",
  resourceId: "weather.com/forecast"
});
```

---

## Key Differences from Original Blueprint

1. **✅ Simplified:** 3 tables instead of 6
2. **✅ Balance on Sponsor:** No separate `sponsor_balances` table
3. **✅ Coverage System:** New `coverage_type` and `coverage_percent` fields
4. **✅ Recurrence Simplified:** Two options instead of complex time-based rules
5. **✅ Resources in JSON:** No `resources` table
6. **✅ No x402_payments Table:** Payments processed in real-time

---

## Related Files

- `01-type-contracts.md` - TypeScript types for these tables
- `../20-architecture/00-system-architecture.md` - How data flows
- `../20-architecture/02-plugin-system.md` - Plugin config examples
- `server/db/schema.ts` - **Actual Drizzle schema** (implementation)
- `server/db/queries.ts` - Pre-built queries
- `drizzle.config.ts` - Drizzle configuration
